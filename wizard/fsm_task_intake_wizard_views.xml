<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="fsm_task_intake_wizard_form" model="ir.ui.view">
        <field name="name">fsm.task.intake.wizard.form</field>
        <field name="model">fsm.task.intake.wizard</field>
        <field name="arch" type="xml">
            <form string="Create Field Service Task" create="0" class="o_form_nosave">
                <header>
                    <field name="state" widget="statusbar" statusbar_visible="customer,type,products,schedule,notes,confirm"/>
                </header>
                <sheet>
                    <group>
                        <field name="task_type_id" invisible="1"/>
                        <field name="partner_id" invisible="1"/>
                        <field name="planned_hours" invisible="1"/>
                        <field name="require_products" invisible="1"/>
                        <field name="require_serials" invisible="1"/>
                        <field name="never_has_product" invisible="1"/>
                        <field name="has_existing_sales_orders" invisible="1"/>
                        <field name="product_category_ids" invisible="1"/>
                        <field name="subscription_category_ids" invisible="1"/>
                        <field name="available_subscription_ids" invisible="1"/>
                        <field name="available_sale_order_ids" invisible="1"/>
                        <field name="available_task_type_ids" invisible="1"/>
                    </group>

                    <!-- Step 1: Customer -->
                    <group invisible="state != 'customer'" col="1" class="o_colspan_2">
                        <field name="partner_id" colspan="2" class="o_colspan_2"
                               options="{'no_create': True, 'no_open': True, 'no_create_edit': True, 'no_quick_create': True}"/>
                        <field name="subscription_id" colspan="2" class="o_colspan_2"
                               domain="[('id', 'in', available_subscription_ids)]"
                               options="{'no_create': True, 'no_open': True, 'no_create_edit': True, 'no_quick_create': True}"/>
                        <field name="show_service_address" invisible="1"/>
                        <field name="service_address_id" colspan="2" class="o_colspan_2"
                               invisible="not show_service_address"
                               options="{'no_create': True, 'no_open': True, 'no_create_edit': True, 'no_quick_create': True}"/>
                    </group>

                    <!-- Step 2: Type -->
                    <group invisible="state != 'type'" col="1" class="o_colspan_2">
                        <field name="task_type_id" colspan="2" class="o_colspan_2"
                               domain="[('id', 'in', available_task_type_ids)]"
                               options="{'no_create': True, 'no_open': True, 'no_create_edit': True, 'no_quick_create': True}"/>
                    </group>

                    <!-- Step 3: Products -->
                    <group invisible="state != 'products' or never_has_product" col="1" class="o_colspan_2">
                        <!-- Only show sales order field if customer has existing orders -->
                        <div invisible="has_existing_sales_orders" class="o_colspan_2" colspan="2">
                            <div class="alert alert-info w-100" role="alert">
                                <p><strong>No existing sales orders found</strong></p>
                                <p>This customer does not have any sales orders. You can add products manually below.</p>
                            </div>
                        </div>
                        <field name="sale_order_id" colspan="2" class="o_colspan_2"
                               domain="[('id', 'in', available_sale_order_ids)]"
                               invisible="not has_existing_sales_orders"
                               options="{'no_create': True, 'no_open': True, 'no_create_edit': True, 'no_quick_create': True}"/>
                        <field name="line_ids" nolabel="1" colspan="2" class="o_colspan_2">
                            <tree editable="bottom">
                                <field name="product_id" domain="[('categ_id','child_of', parent.product_category_ids)]"
                                       options="{'no_create': True, 'no_open': True, 'no_create_edit': True, 'no_quick_create': True}"/>
                                <field name="quantity"/>
                                <field name="tracking" invisible="1"/>
                                <field name="is_service" invisible="1"/>
                                <field name="lot_id"
                                       invisible="tracking != 'lot' or is_service"/>
                                <field name="lot_ids" widget="many2many_tags"
                                       invisible="tracking != 'serial' or is_service"/>
                            </tree>
                        </field>
                    </group>

                    <!-- Step 4: Schedule -->
                    <group invisible="state != 'schedule'">
                        <group string="Filters">
                            <field name="filter_use_date"/>
                            <field name="date_filter_start" invisible="not filter_use_date"/>
                            <field name="date_filter_end" invisible="not filter_use_date"/>
                            <field name="filter_use_time"/>
                            <field name="time_filter_start" widget="float_time" invisible="not filter_use_time"/>
                            <field name="time_filter_end" widget="float_time" invisible="not filter_use_time"/>
                        </group>
                        <group string="Filter by Team (Optional)">
                            <field name="team_id" options="{'no_create': True, 'no_open': True}"/>
                            <field name="qualified_team_ids" invisible="1"/>
                        </group>

                        <group string="Available Time Slots" col="1" class="o_colspan_2">
                            <field name="slot_index" invisible="1"/>
                            <field name="slot1_label" invisible="1"/>
                            <field name="slot2_label" invisible="1"/>
                            <field name="slot3_label" invisible="1"/>
                            <field name="slot1_start" invisible="1"/>
                            <field name="slot2_start" invisible="1"/>
                            <field name="slot3_start" invisible="1"/>
                            <field name="slot1_end" invisible="1"/>
                            <field name="slot2_end" invisible="1"/>
                            <field name="slot3_end" invisible="1"/>
                            <field name="slot1_team_label" invisible="1"/>
                            <field name="slot2_team_label" invisible="1"/>
                            <field name="slot3_team_label" invisible="1"/>
                            <field name="slot1_is_preferred" invisible="1"/>
                            <field name="slot2_is_preferred" invisible="1"/>
                            <field name="slot3_is_preferred" invisible="1"/>

                            <div class="o_colspan_2" style="white-space: nowrap;">
                                <field name="selected_slot" widget="radio" nolabel="1"
                                       options="{'horizontal': false}"/>
                            </div>

                            <div class="o_colspan_2" style="margin-top: 0.5rem;">
                                <div class="alert alert-success w-100" role="alert" invisible="not slot1_label" style="width: 100%; max-width: none;">
                                    <strong>Option 1:</strong>
                                    <span class="badge badge-success" invisible="not slot1_team_label">
                                        <field name="slot1_team_label" readonly="1" nolabel="1"/>
                                    </span>
                                    <field name="slot1_label" readonly="1" nolabel="1" class="ms-1"/>
                                </div>
                                <div class="alert alert-success w-100" role="alert" invisible="not slot2_label" style="width: 100%; max-width: none;">
                                    <strong>Option 2:</strong>
                                    <span class="badge badge-success" invisible="not slot2_team_label">
                                        <field name="slot2_team_label" readonly="1" nolabel="1"/>
                                    </span>
                                    <field name="slot2_label" readonly="1" nolabel="1" class="ms-1"/>
                                </div>
                                <div class="alert alert-success w-100" role="alert" invisible="not slot3_label" style="width: 100%; max-width: none;">
                                    <strong>Option 3:</strong>
                                    <span class="badge badge-success" invisible="not slot3_team_label">
                                        <field name="slot3_team_label" readonly="1" nolabel="1"/>
                                    </span>
                                    <field name="slot3_label" readonly="1" nolabel="1" class="ms-1"/>
                                </div>
                            </div>

                            <button name="action_more_options" string="Show More Times" translate="True"
                                    type="object" class="btn-link"/>
                        </group>
                    </group>

                    <!-- Step 5: Notes -->
                    <group invisible="state != 'notes'">
                        <group>
                            <field name="notes" nolabel="1" colspan="2" class="o_colspan_2"
                                   placeholder="Enter any internal notes or special instructions..."/>
                        </group>
                    </group>

                    <!-- Step 6: Confirm -->
                    <group invisible="state != 'confirm'" col="1" class="o_colspan_2">
                        <!-- Warnings full width -->
                        <field name="warning_customer_phone_missing" invisible="1"/>
                        <field name="warning_no_service_address" invisible="1"/>
                        <field name="warning_missing_serials" invisible="1"/>
                        <field name="warning_planned_hours_zero" invisible="1"/>
                        <field name="warning_task_type_mapping" invisible="1"/>
                        <field name="warning_no_products_or_so" invisible="1"/>

                        <div class="o_colspan_2" colspan="2">
                            <div class="alert alert-warning w-100" role="alert" invisible="not warning_customer_phone_missing">
                                <i class="fa fa-warning"/> Customer phone number is missing.
                            </div>
                            <div class="alert alert-warning w-100" role="alert" invisible="not warning_no_service_address">
                                <i class="fa fa-warning"/> Service address is not specified.
                            </div>
                            <div class="alert alert-danger w-100" role="alert" invisible="not warning_missing_serials">
                                <i class="fa fa-exclamation-circle"/> Some products require serial/lot numbers.
                            </div>
                            <div class="alert alert-danger w-100" role="alert" invisible="not warning_planned_hours_zero">
                                <i class="fa fa-exclamation-circle"/> Planned hours cannot be zero.
                            </div>
                            <div class="alert alert-danger w-100" role="alert" invisible="not warning_task_type_mapping">
                                <i class="fa fa-exclamation-circle"/> Task type must have a project assigned.
                            </div>
                            <div class="alert alert-danger w-100" role="alert" invisible="not warning_no_products_or_so">
                                <i class="fa fa-exclamation-circle"/> This task type requires products or a sales order.
                            </div>
                        </div>

                        <group string="Summary" class="o_colspan_2">
                            <field name="task_type_id" readonly="1" colspan="2" class="o_colspan_2"/>
                            <field name="partner_id" readonly="1" colspan="2" class="o_colspan_2"/>
                            <field name="service_address_id" readonly="1" colspan="2" class="o_colspan_2"
                                   invisible="not service_address_id"/>
                            <field name="selected_slot_label" readonly="1" string="Scheduled Time" colspan="2" class="o_colspan_2"/>
                            <field name="team_id" readonly="1" colspan="2" class="o_colspan_2"
                                   invisible="not team_id"/>
                        </group>
                        
                        <group string="Products/Services" invisible="not line_ids" class="o_colspan_2">
                            <field name="line_ids" nolabel="1" readonly="1" colspan="2" class="o_colspan_2">
                                <tree>
                                    <field name="product_id"/>
                                    <field name="quantity"/>
                                    <field name="lot_id"/>
                                    <field name="lot_ids" widget="many2many_tags"/>
                                </tree>
                            </field>
                        </group>
                    </group>
                </sheet>
                <footer>
                    <button name="action_back" string="Back" translate="True" type="object" class="btn-secondary"
                            invisible="state == 'type'"/>
                    <button name="action_next" string="Next" translate="True" type="object" class="btn-primary"
                            invisible="state == 'confirm'"/>
                    <button name="action_create_task" string="Create Task" translate="True" type="object" class="btn-primary"
                            invisible="state != 'confirm'"/>
                    <button string="Close" translate="True" special="cancel" class="btn-secondary"/>
                </footer>
            </form>
        </field>
    </record>

    <record id="action_fsm_task_intake_wizard" model="ir.actions.act_window">
        <field name="name">Create Field Service Task</field>
        <field name="res_model">fsm.task.intake.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="binding_model_id" ref="model_project_task"/>
    </record>

</odoo>
